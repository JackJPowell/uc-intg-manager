<!-- Available Integration Card Partial -->
<div class="integration-card relative bg-uc-card rounded-xl p-3 sm:p-5 border {% if install_error %}border-red-500/50{% else %}border-uc-border{% endif %} {% if not integration.official and not integration.installed and not integration.external %}hover:border-uc-primary/50{% endif %}"
     id="card-{{ integration.driver_id }}"
     data-name="{{ integration.name }}"
     data-description="{{ integration.description }}"
     data-developer="{{ integration.developer }}"
     data-categories="{{ integration.categories|join(' ') if integration.categories else integration.category }}"
     data-installed="{{ 'true' if (integration.installed or integration.driver_installed or integration.external) else 'false' }}"
     data-has-update="{{ 'true' if integration.update_available else 'false' }}"
     data-status="{% if install_error %}error{% else %}{{ integration.install_status }}{% endif %}">
    <div class="flex flex-col h-full">
        <!-- Header -->
        <div class="flex items-start justify-between gap-2 mb-3">
            <div class="flex items-center space-x-3 min-w-0 flex-1">
                <!-- Icon - default color for all -->
                {% set icon_color = 'text-uc-primary' %}
                {% set bg_color = 'bg-uc-primary/20' %}

                
                <div class="flex-shrink-0 w-10 h-10 {{ bg_color }} rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-lg fa-{{ integration.icon or 'puzzle-piece' }} {{ icon_color }}"></i>
                </div>
                <div class="min-w-0">
                    <h4 class="font-semibold text-white text-sm sm:text-base truncate">{{ integration.name }}</h4>
                    {% if integration.version %}
                    {% if integration.home_page and 'github.com' in integration.home_page %}
                    {% set repo_path = integration.home_page.split('github.com/')[1].rstrip('/').split('?')[0].split('#')[0] %}
                    {% set path_parts = repo_path.split('/') %}
                    {% if path_parts|length >= 2 and path_parts[0] and path_parts[1] %}
                    {% set owner = path_parts[0] %}
                    {% set repo = path_parts[1] %}
                    {% set release_url = "/api/release-notes/" ~ owner ~ "/" ~ repo ~ "/v" ~ integration.version %}
                    {% else %}
                    {% set release_url = "/api/release-notes/unavailable/v" ~ integration.version %}
                    {% endif %}
                    {% else %}
                    {% set release_url = "/api/release-notes/unavailable/v" ~ integration.version %}
                    {% endif %}
                    <a href="#" 
                       hx-get="{{ release_url }}"
                       hx-target="#modal-content"
                       hx-swap="innerHTML"
                       hx-on::before-request="openModal('Release Notes - v{{ integration.version }}')"
                       onclick="event.preventDefault();"
                       class="text-xs text-gray-500 hover:text-uc-primary transition-colors cursor-pointer" 
                       title="View release notes for v{{ integration.version }}">
                        v{{ integration.version }}
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Status Badge -->
            <div class="flex items-center flex-wrap gap-2 flex-shrink-0">
            {% if install_error %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-500/20 text-red-300 flex-shrink-0" title="{{ install_error }}">
                Failed
            </span>
            {% elif just_installed %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/20 text-green-300 flex-shrink-0" title="Just installed successfully">
                <i class="fa-solid fa-check w-3 h-3 mr-1"></i>
                Installed
            </span>
            {% elif integration.official %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-teal-500/20 text-teal-300" title="Official UC integration - delivered with firmware">
                Official
            </span>
            {% elif integration.external %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-500/20 text-blue-300" title="Running externally via Docker or network">
                External
            </span>
            {% elif integration.update_available %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-500/20 text-yellow-300" title="{% if integration.can_update %}Update available: {{ integration.latest_version }}{% else %}Update available but requires manual upgrade (version too old for automatic update){% endif %}">
                <i class="fa-solid fa-arrow-up w-3 h-3 mr-1"></i>
                Update
            </span>
            {% elif just_updated %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/20 text-green-300" title="Just updated successfully">
                <i class="fa-solid fa-check w-3 h-3 mr-1"></i>
                Updated
            </span>
            {% elif integration.installed %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/20 text-green-300" title="Configured and running">
                Configured
            </span>
            {% elif integration.driver_installed %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-500/20 text-yellow-300" title="Driver installed - needs configuration">
                Installed
            </span>
            {% endif %}
            </div>
        </div>
        
        <!-- Description -->
        <p class="text-sm text-gray-400 flex-1 mb-4 line-clamp-2">
            {{ integration.description or 'No description available' }}
        </p>
        
        <!-- Footer -->
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-2 pt-3 border-t border-uc-border">
            <div class="flex items-center flex-wrap gap-2 text-xs text-gray-500 min-w-0">
                {% if integration.developer %}
                <span class="truncate">{{ integration.developer }}</span>
                {% endif %}
                {% if integration.category %}
                <span class="inline-flex items-center px-2 py-0.5 rounded bg-uc-darker text-gray-400 flex-shrink-0">
                    {{ integration.category }}
                </span>
                {% endif %}
            </div>
            
            <div class="flex items-center justify-end flex-wrap gap-2 flex-shrink-0" id="actions-{{ integration.driver_id }}">
                {% if integration.driver_installed %}
                <!-- Delete button for all installed drivers -->
                <button
                    hx-get="/api/integration/{{ integration.driver_id }}/delete-confirm"
                    hx-target="#modal-content"
                    hx-swap="innerHTML"
                    hx-indicator="#delete-overlay-{{ integration.driver_id }}"
                    hx-on::before-request="openModal('Delete Integration')"
                    class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-uc-darker rounded transition-colors"
                    title="Delete integration">
                    <i class="fa-solid fa-trash-alt h-4 w-4"></i>
                </button>
                {% endif %}
                
                {% if integration.home_page %}
                <a href="{{ integration.home_page }}" target="_blank" rel="noopener"
                   class="p-1.5 text-gray-400 hover:text-white hover:bg-uc-darker rounded transition-colors"
                   title="View on GitHub">
                    <i class="fa-brands fa-github h-4 w-4"></i>
                </a>
                {% endif %}
                
                {% if integration.official %}
                <a href="http://{{ remote_ip }}/configurator/#/integrations" target="_blank" rel="noopener" class="text-xs text-teal-400 hover:text-teal-300 italic transition-colors" title="Manage in firmware settings">
                    Firmware <i class="fas fa-external-link-alt ml-0.5"></i>
                </a>
                {% elif integration.external %}
                <span class="text-xs text-blue-400 italic">Via Docker</span>
                {% elif integration.update_available and integration.can_update %}
                <!-- Update button for installed integrations with updates -->
                {% if integration.home_page and 'github.com' in integration.home_page %}
                {% set repo_path = integration.home_page.split('github.com/')[1].rstrip('/').split('?')[0].split('#')[0] %}
                {% set path_parts = repo_path.split('/') %}
                {% if path_parts|length >= 2 and path_parts[0] and path_parts[1] %}
                {% set owner = path_parts[0] %}
                {% set repo = path_parts[1] %}
                {% set release_url = "/api/release-notes/" ~ owner ~ "/" ~ repo ~ "/v" ~ integration.version %}
                {% else %}
                {% set release_url = "/api/release-notes/unavailable/v" ~ integration.version %}
                {% endif %}
                {% else %}
                {% set release_url = "/api/release-notes/unavailable/v" ~ integration.version %}
                {% endif %}
                <a href="#" 
                   hx-get="{{ release_url }}"
                   hx-target="#modal-content"
                   hx-swap="innerHTML"
                   hx-on::before-request="openModal('Release Notes - v{{ integration.version }}')"
                   onclick="event.preventDefault();"
                   class="text-xs text-gray-400 hover:text-uc-primary transition-colors cursor-pointer" 
                   title="View release notes for v{{ integration.version }}">
                    v{{ integration.version }}
                </a>
                <span class="text-gray-500">â†’</span>
                
                <!-- Split button: Main update + Dropdown for version selection -->
                {% if path_parts|length >= 2 and path_parts[0] and path_parts[1] %}
                <div class="relative inline-flex rounded-lg shadow-sm">
                    <!-- Main Update Button -->
                    {% if integration.can_auto_update %}
                    {# Can do automated backup/restore - direct update #}
                    <button 
                        class="inline-flex items-center px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 text-xs font-medium rounded-l-lg transition-colors border-r border-yellow-500/30"
                        hx-post="{% if integration.instance_id %}/api/integration/{{ integration.instance_id }}/update?version={{ integration.latest_version }}{% else %}/api/driver/{{ integration.driver_id }}/update?version={{ integration.latest_version }}{% endif %}"
                        hx-target="#card-{{ integration.driver_id }}"
                        hx-swap="outerHTML"
                        hx-indicator="#overlay-{{ integration.driver_id }}"
                        title="Update to {{ integration.latest_version }}">
                        <i class="fa-solid fa-upload h-3 w-3 mr-1"></i>
                        {{ integration.latest_version }}
                    </button>
                    {% else %}
                    {# Cannot do automated backup - show warning modal first #}
                    <button 
                        class="inline-flex items-center px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 text-xs font-medium rounded-l-lg transition-colors border-r border-yellow-500/30"
                        hx-get="/api/integration/{{ integration.driver_id }}/update-confirm"
                        hx-target="#modal-content"
                        hx-swap="innerHTML"
                        hx-on::before-request="openModal('Update Confirmation')"
                        title="Update to {{ integration.latest_version }} (requires reconfiguration)">
                        <i class="fa-solid fa-exclamation-triangle h-3 w-3 mr-1"></i>
                        {{ integration.latest_version }}
                    </button>
                    {% endif %}
                    
                    <!-- Dropdown Toggle Button -->
                    <button 
                        type="button"
                        class="inline-flex items-center px-2 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 text-xs font-medium rounded-r-lg transition-colors"
                        onclick="toggleDropdown(event, 'update-dropdown-{{ integration.driver_id }}')"
                        title="More options">
                        <i id="update-chevron-{{ integration.driver_id }}" class="fa-solid fa-chevron-down h-3 w-3 transition-transform duration-200"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="update-dropdown-{{ integration.driver_id }}" class="hidden absolute right-0 top-full mt-1 w-48 rounded-lg shadow-lg bg-uc-card border border-uc-border z-[9999]">
                        <div class="py-1">
                            <button
                                class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-uc-darker hover:text-white transition-colors flex items-center gap-2 rounded-lg"
                                hx-get="/api/version-selector/{{ owner }}/{{ repo }}/{{ integration.driver_id }}"
                                hx-target="#modal-content"
                                hx-swap="innerHTML"
                                hx-on::before-request="toggleDropdown(event, 'update-dropdown-{{ integration.driver_id }}', true); openModal('Select Version');"
                                title="Choose a specific version to install">
                                <i class="fa-solid fa-list-ul h-4 w-4"></i>
                                Select Version
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Fallback for invalid GitHub URL -->
                {% if integration.can_auto_update %}
                {# Can do automated backup/restore - direct update #}
                <button 
                    class="inline-flex items-center px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 text-xs font-medium rounded-lg transition-colors"
                    hx-post="{% if integration.instance_id %}/api/integration/{{ integration.instance_id }}/update?version={{ integration.latest_version }}{% else %}/api/driver/{{ integration.driver_id }}/update?version={{ integration.latest_version }}{% endif %}"
                    hx-target="#card-{{ integration.driver_id }}"
                    hx-swap="outerHTML"
                    hx-indicator="#overlay-{{ integration.driver_id }}"
                    title="Update to {{ integration.latest_version }}">
                    <i class="fa-solid fa-upload h-3 w-3 mr-1"></i>
                    {{ integration.latest_version }}
                </button>
                {% else %}
                {# Cannot do automated backup - show warning modal first #}
                <button 
                    class="inline-flex items-center px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 text-xs font-medium rounded-lg transition-colors"
                    hx-get="/api/integration/{{ integration.driver_id }}/update-confirm"
                    hx-target="#modal-content"
                    hx-swap="innerHTML"
                    hx-on::before-request="openModal('Update Confirmation')"
                    title="Update to {{ integration.latest_version }} (requires reconfiguration)">
                    <i class="fa-solid fa-exclamation-triangle h-3 w-3 mr-1"></i>
                    {{ integration.latest_version }}
                </button>
                {% endif %}
                    <i class="fa-solid fa-upload h-3 w-3 mr-1"></i>
                    {{ integration.latest_version }}
                </button>
                {% endif %}
                {% elif just_updated %}
                <!-- Just updated indicator -->
                <span class="inline-flex items-center text-xs text-green-400">
                    <i class="fa-solid fa-check mr-1"></i>
                    Up to date
                </span>
                {% elif just_installed %}
                <!-- Just installed indicator -->
                <span class="inline-flex items-center text-xs text-green-400">
                    <i class="fa-solid fa-check mr-1"></i>
                    Installed
                </span>
                {% elif install_error %}
                <!-- Retry button for failed install -->
                <button 
                    class="install-btn inline-flex items-center px-3 py-1.5 bg-uc-primary hover:bg-uc-secondary text-white text-xs font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    hx-post="/api/integration/{{ integration.driver_id }}/install"
                    hx-target="#card-{{ integration.driver_id }}"
                    hx-swap="outerHTML"
                    hx-indicator="#overlay-{{ integration.driver_id }}"
                    title="Retry installation">
                    <i class="fa-solid fa-rotate-right h-3 w-3 mr-1"></i>
                    Retry
                </button>
                {% elif integration.installed or integration.driver_installed %}
                <!-- Already installed - show Select Version for custom integrations -->
                {% if not integration.official and not integration.external %}
                {% if integration.home_page and 'github.com' in integration.home_page %}
                {% set repo_path = integration.home_page.split('github.com/')[1].rstrip('/').split('?')[0].split('#')[0] %}
                {% set path_parts = repo_path.split('/') %}
                {% if path_parts|length >= 2 and path_parts[0] and path_parts[1] %}
                {% set owner = path_parts[0] %}
                {% set repo = path_parts[1] %}
                <button 
                    class="inline-flex items-center px-3 py-1.5 bg-uc-darker hover:bg-uc-card text-gray-400 hover:text-white text-xs font-medium rounded-lg transition-colors"
                    hx-get="/api/version-selector/{{ owner }}/{{ repo }}/{{ integration.driver_id }}"
                    hx-target="#modal-content"
                    hx-swap="innerHTML"
                    hx-on::before-request="openModal('Select Version');"
                    title="Choose a specific version to install">
                    <i class="fa-solid fa-list-ul h-3 w-3 mr-1"></i>
                    Select Version
                </button>
                {% endif %}
                {% endif %}
                {% endif %}
                {% else %}
                <!-- Install button with dropdown for version selection -->
                {% if integration.home_page and 'github.com' in integration.home_page %}
                {% set repo_path = integration.home_page.split('github.com/')[1].rstrip('/').split('?')[0].split('#')[0] %}
                {% set path_parts = repo_path.split('/') %}
                {% if path_parts|length >= 2 and path_parts[0] and path_parts[1] %}
                {% set owner = path_parts[0] %}
                {% set repo = path_parts[1] %}
                <div class="relative inline-flex rounded-lg shadow-sm">
                    <!-- Main Install Button -->
                    <button 
                        class="install-btn inline-flex items-center px-3 py-1.5 bg-uc-primary hover:bg-uc-secondary text-white text-xs font-medium rounded-l-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed border-r border-uc-secondary"
                        hx-post="/api/integration/{{ integration.driver_id }}/install"
                        hx-target="#card-{{ integration.driver_id }}"
                        hx-swap="outerHTML"
                        hx-indicator="#overlay-{{ integration.driver_id }}"
                        title="Install latest version">
                        <i class="fa-solid fa-download h-3 w-3 mr-1"></i>
                        Install
                    </button>
                    
                    <!-- Dropdown Toggle Button -->
                    <button 
                        type="button"
                        class="inline-flex items-center px-2 py-1.5 bg-uc-primary hover:bg-uc-secondary text-white text-xs font-medium rounded-r-lg transition-colors"
                        onclick="toggleDropdown(event, 'install-dropdown-{{ integration.driver_id }}')"
                        title="More options">
                        <i id="install-chevron-{{ integration.driver_id }}" class="fa-solid fa-chevron-down h-3 w-3 transition-transform duration-200"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="install-dropdown-{{ integration.driver_id }}" class="hidden absolute right-0 top-full mt-1 w-48 rounded-lg shadow-lg bg-uc-card border border-uc-border z-[9999]">
                        <div class="py-1">
                            <button
                                class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-uc-darker hover:text-white transition-colors flex items-center gap-2 rounded-lg"
                                hx-get="/api/version-selector/{{ owner }}/{{ repo }}/{{ integration.driver_id }}"
                                hx-target="#modal-content"
                                hx-swap="innerHTML"
                                hx-on::before-request="toggleDropdown(event, 'install-dropdown-{{ integration.driver_id }}', true); openModal('Select Version');"
                                title="Choose a specific version to install">
                                <i class="fa-solid fa-list-ul h-4 w-4"></i>
                                Select Version
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Fallback for invalid GitHub URL parsing -->
                <button 
                    class="install-btn inline-flex items-center px-3 py-1.5 bg-uc-primary hover:bg-uc-secondary text-white text-xs font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    hx-post="/api/integration/{{ integration.driver_id }}/install"
                    hx-target="#card-{{ integration.driver_id }}"
                    hx-swap="outerHTML"
                    hx-indicator="#overlay-{{ integration.driver_id }}"
                    title="Install integration">
                    <i class="fa-solid fa-download h-3 w-3 mr-1"></i>
                    Install
                </button>
                {% endif %}
                {% else %}
                <!-- Fallback for non-GitHub integrations -->
                <button 
                    class="install-btn inline-flex items-center px-3 py-1.5 bg-uc-primary hover:bg-uc-secondary text-white text-xs font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    hx-post="/api/integration/{{ integration.driver_id }}/install"
                    hx-target="#card-{{ integration.driver_id }}"
                    hx-swap="outerHTML"
                    hx-indicator="#overlay-{{ integration.driver_id }}"
                    title="Install integration">
                    <i class="fa-solid fa-download h-3 w-3 mr-1"></i>
                    Install
                </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Overlay for install/update - positioned as direct child of card for proper centering -->
    {% if not integration.official and not integration.external and (not integration.installed or integration.driver_installed or (integration.update_available and integration.can_update)) %}
    <div id="overlay-{{ integration.driver_id }}" class="hidden absolute inset-0 bg-uc-darker/90 rounded-xl z-10 pointer-events-none">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-uc-primary mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm text-gray-300">{% if integration.update_available %}Updating...{% else %}Installing...{% endif %}</span>
        </div>
    </div>
    {% endif %}
    
    <!-- Upgrade overlay - always present for installed integrations so HTMX can find it during version selector requests -->
    {% if integration.driver_installed and not integration.official and not integration.external %}
    <div id="upgrade-overlay-{{ integration.driver_id }}" 
         data-current-version="{{ integration.version }}"
         class="hidden absolute inset-0 bg-uc-darker/90 rounded-xl z-10 pointer-events-none">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-yellow-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm text-gray-300 upgrade-text">Upgrading...</span>
        </div>
    </div>
    {% endif %}
    
    <!-- Delete overlay -->
    {% if integration.driver_installed %}
    <div id="delete-overlay-{{ integration.driver_id }}" class="hidden absolute inset-0 bg-uc-darker/90 rounded-xl z-10 pointer-events-none">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-red-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm text-gray-300">Deleting...</span>
        </div>
    </div>
    {% endif %}
</div>
